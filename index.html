<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ma collection Pokémon (Lite)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{--bg:#f8fafc;--panel:#fff;--ink:#0f172a;--muted:#64748b;--ring:#e2e8f0;--brand:#2563eb}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  body{color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--ring);z-index:10}
  .wrap{max-width:1150px;margin:auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
  h1{font-size:20px;margin:0;display:flex;align-items:center;gap:10px}
  .bar{display:flex;gap:8px;align-items:center;margin-left:auto}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .btn:hover{box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .hint{font-size:12px;color:var(--muted)}

  .tabs{max-width:1150px;margin:14px auto 0;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:0 16px}
  .tab{padding:12px;border:1px solid var(--ring);border-radius:12px;background:#fff;text-align:center;cursor:pointer;user-select:none}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

  main{max-width:1150px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;overflow:visible}
  .card h3{margin:0;font-size:14px;padding:12px;border-bottom:1px solid var(--ring)}

  /* Filters grid */
  .filters{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;padding:12px}
  .filters .col{display:flex;flex-direction:column;gap:6px}
  .filters input[type="text"], .filters select{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:12px;background:#f8fafc}
  .col.span-2{grid-column:span 2}
  @media(max-width:900px){.filters{grid-template-columns:repeat(2,minmax(0,1fr))}.col.span-2{grid-column:span 2}}
  @media(max-width:560px){.filters{grid-template-columns:1fr}.col.span-2{grid-column:span 1}}

  .legend{display:flex;gap:14px;align-items:center;margin:6px 12px 14px;flex-wrap:wrap}
  .legend span{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}

  .section{margin:18px 0}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:640px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media(min-width:980px){.grid{grid-template-columns:repeat(5,1fr)}}

  .item{border:1px solid var(--ring);border-radius:14px;overflow:hidden;background:#fff}
  .thumb{background:#eef2f7;aspect-ratio:3/4;display:flex;align-items:center;justify-content:center;cursor:zoom-in}
  .thumb.img-short{aspect-ratio:16/9}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .meta{padding:10px}
  .meta .t{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta .s{color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .empty{padding:24px;text-align:center;color:var(--muted);border:1px dashed var(--ring);border-radius:12px;background:#fff}

  /* Pokéball badges */
  .badges{display:inline-flex;gap:6px;margin-left:6px;vertical-align:middle}
  .ball{width:14px;height:14px;display:inline-block;border-radius:50%;position:relative;border:1px solid rgba(0,0,0,.15)}
  .ball::before,.ball::after{content:"";position:absolute;left:0;right:0}
  .ball::before{top:49%;height:1px;background:rgba(0,0,0,.25)}
  .ball::after{top:50%;transform:translate(-50%,-50%);left:50%;width:4px;height:4px;border-radius:50%;background:#fff;border:1px solid rgba(0,0,0,.25)}
  .ball.red{background:#ef4444}
  .ball.yellow{background:#eab308}
  .ball.blue{background:#3b82f6}

  /* Rarity icons */
  .rarity{display:inline-flex;gap:4px;align-items:center}
  .rarity svg{width:14px;height:14px}
  .rarity-label{font-size:12px;color:var(--muted)}

  /* Rarity dropdown */
  .multi{position:relative}
  .multi-btn{width:100%;padding:10px 12px;border:1px solid var(--ring);background:#fff;border-radius:12px;cursor:pointer;text-align:left}
  .multi-panel{position:absolute;z-index:30;top:44px;left:0;right:0;background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.08);padding:10px;max-height:40vh;overflow:auto}
  .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
  @media(max-width:900px){.chips{grid-template-columns:repeat(4,minmax(0,1fr))}}
  @media(max-width:560px){.chips{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .chip{display:inline-flex;align-items:center}
  .chip input{display:none}
  .chip label{border:1px solid var(--ring);background:#fff;border-radius:10px;width:36px;height:36px;padding:0;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .chip input:checked + label{background:var(--brand);color:#fff;border-color:var(--brand)}
  .link{background:none;border:none;color:var(--brand);cursor:pointer;padding:0;font-size:12px}
  .link:hover{text-decoration:underline}
  .multi-actions{display:flex;gap:8px;align-items:center;margin-top:8px;justify-content:flex-end}

  /* Modal viewer (ZOOM) */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.8);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.open{display:flex}
  .modal img{max-width:90vw;max-height:85vh;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.3)}
  .modal .close{position:absolute;top:14px;right:18px;background:#fff;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;cursor:pointer}

  /* ===== Stats ===== */
  .stats-wrap{display:flex;flex-direction:column;gap:12px;padding:12px}
  .stat-row{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  .stat-head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;cursor:pointer}
  .stat-title{font-weight:600}
  .progress{flex:1;height:12px;background:var(--bg);border:1px solid var(--ring);border-radius:999px;overflow:hidden;margin:0 12px}
  .progress > span{display:block;height:100%;width:0;border-radius:999px;
    background:linear-gradient(90deg,#ef4444 0%, #f59e0b 50%, #10b981 100%);
    transition:width .3s ease}
  .stat-meta{font-size:12px;color:var(--muted);min-width:110px;text-align:right}
  .stat-body{display:none;border-top:1px solid var(--ring);padding:12px;background:#f9fafb}
  .stat-row.open .stat-body{display:block}
  .stat-break{display:flex;gap:16px;flex-wrap:wrap;font-size:13px;color:var(--ink)}
  .missing{margin-top:8px}
  .missing h4{margin:8px 0 4px 0;font-size:13px;color:var(--muted)}
  .chips-list{display:flex;flex-wrap:wrap;gap:6px}
  .chips-list span{background:#fff;border:1px solid var(--ring);border-radius:999px;padding:4px 8px;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <img alt="pokeball" src="https://upload.wikimedia.org/wikipedia/commons/5/53/Pok%C3%A9_Ball_icon.svg" style="width:22px;height:22px">
    <h1>Ma collection Pokémon (Lite)</h1>
    <div class="bar">
      <span class="uploads">
        <label class="btn">Cartes CSV <input id="csv-cards" type="file" accept=".csv" hidden></label>
        <label class="btn">Scellé CSV <input id="csv-sealed" type="file" accept=".csv" hidden></label>
        <label class="btn">Gradées CSV <input id="csv-graded" type="file" accept=".csv" hidden></label>
      </span>
      <button id="load-demo" class="btn">Exemple</button>
    </div>
  </div>
</header>

<div class="tabs">
  <div class="tab active" data-tab="cards">Cartes</div>
  <div class="tab" data-tab="sealed">Scellé</div>
  <div class="tab" data-tab="graded">Gradées</div>
  <div class="tab" data-tab="stats">Stats</div>
</div>

<main>
  <!-- CARTES -->
  <section class="panel" id="panel-cards">
    <div class="card">
      <h3>Filtres</h3>
      <div class="filters">
        <div class="col"><label>Recherche</label><input id="q" placeholder="Nom, numéro…" type="text"></div>
        <div class="col"><label>Série</label><select id="serie"><option value="all">Toutes</option></select></div>
        <div class="col"><label>Vue</label>
          <select id="view">
            <option value="owned">Possédées</option>
            <option value="missing">Manquantes (normales)</option>
            <option value="all">Toutes</option>
          </select>
        </div>
        <div class="col span-2"><label>Raretés</label>
          <div class="multi">
            <button id="rarityBtn" type="button" class="multi-btn">Toutes les raretés</button>
            <div id="rarityDD" class="multi-panel" hidden>
              <div id="rarityChips" class="chips"></div>
              <div class="multi-actions"><button type="button" id="checkAll" class="link">Tout</button><span>·</span><button type="button" id="uncheckAll" class="link">Aucun</button></div>
            </div>
          </div>
        </div>
      </div>
      <div class="legend">
        <span><b>Versions :</b></span>
        <span><i class="ball red"></i> Normale</span>
        <span><i class="ball yellow"></i> Reverse</span>
        <span><i class="ball blue"></i> Spéciale</span>
      </div>
    </div>
    <div id="cards-root" class="section"></div>
  </section>

  <!-- SCELLÉ -->
  <section class="panel" id="panel-sealed" style="display:none">
    <div class="card">
      <h3>Filtres scellé</h3>
      <div class="filters">
        <div class="col"><label>Recherche</label><input id="qs" placeholder="Type, détail, commentaire…" type="text"></div>
        <div class="col"><label>Série</label><select id="serieS"><option value="all">Toutes</option></select></div>
        <div class="col"><label>Type</label><select id="typeS"><option value="all">Tous</option></select></div>
        <div class="col"></div>
      </div>
    </div>
    <div id="sealed-root" class="section"></div>
  </section>

  <!-- GRADÉES -->
  <section class="panel" id="panel-graded" style="display:none">
    <div class="card">
      <h3>Filtres gradées</h3>
      <div class="filters">
        <div class="col"><label>Recherche</label><input id="qg" placeholder="Nom, édition…" type="text"></div>
        <div class="col"><label>Société</label><select id="company"><option value="all">Toutes</option></select></div>
        <div class="col"><label>Note minimale: <span id="minG_label">0</span></label><input id="minG" type="range" min="0" max="10" step="0.5" value="0"></div>
        <div class="col"><span class="hint">Astuce : ajoute une colonne « Prix » pour afficher un prix.</span></div>
      </div>
    </div>
    <div id="graded-root" class="section"></div>
  </section>

  <!-- STATS -->
  <section class="panel" id="panel-stats" style="display:none">
    <div class="card">
      <h3>Statistiques de complétion</h3>
      <div id="stats-root" class="stats-wrap"></div>
    </div>
  </section>

  <p class="hint">Ce site charge automatiquement <code>cartes.csv</code>, <code>scelle.csv</code> et <code>gradees.csv</code> s’ils sont présents à la racine du dépôt. Pour les images, mets une colonne <b>Image</b> (ou <b>Image URL</b> pour les cartes) avec une URL absolue ou un chemin relatif du repo (ex : <code>images/pikachu.jpg</code>).</p>
</main>

<!-- Modal image viewer -->
<div id="imgModal" class="modal" aria-hidden="true">
  <button class="close" id="modalClose">Fermer ✕</button>
  <img id="modalImg" alt="aperçu"/>
</div>

<script>
  (document.readyState === 'loading') ? document.addEventListener('DOMContentLoaded', initApp) : initApp();

  function initApp(){
    // ——— Affichage : cacher boutons/démo par défaut. ?upload pour les revoir ———
    const params = new URLSearchParams(location.search);
    const SHOW_UPLOADS = params.has('upload');
    if(!SHOW_UPLOADS){
      const up = document.querySelector('.uploads'); if(up) up.style.display='none';
      const demoBtn = document.getElementById('load-demo'); if(demoBtn) demoBtn.style.display='none';
    }

    // Helpers de normalisation + slug
    const normalize = (s) => String(s ?? '').normalize('NFC').trim().replace(/\s+/g,' ');
    const slugify = (s) => normalize(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

    let SERIE_CANON = new Map();

    // ——— Tabs ———
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const name = t.dataset.tab;
      document.getElementById('panel-cards').style.display   = (name==='cards') ? 'block' : 'none';
      document.getElementById('panel-sealed').style.display  = (name==='sealed')? 'block' : 'none';
      document.getElementById('panel-graded').style.display  = (name==='graded')? 'block' : 'none';
      document.getElementById('panel-stats').style.display   = (name==='stats') ? 'block' : 'none';
      render();
    }));

    // --- Mapping raretés ---
    const RARITY_MAP = {'1':'commune','2':'peu_commune','3':'rare','4':'rare','5':'rare_silver','6':'rare_silver','7':'promo','32':'double_rare','33':'illustration_rare','34':'ultra_rare_silver','35':'illustration_sr','36':'hyper_rare','39':'chromatique_ur','40':'high_tech'};
    const RARITY_LABELS = {commune:'Commune',peu_commune:'Peu commune',rare:'Rare',rare_silver:'Rare',double_rare:'Double rare',ultra_rare_silver:'Ultra rare',illustration_rare:'Illustration rare',illustration_sr:'Illustration spéciale rare',hyper_rare:'Hyper rare',chromatique_ur:'Chromatique ultra rare',high_tech:'HIGH-TECH rare',promo:'Promo'};
    const RARITY_ORDER = ['commune','peu_commune','rare','rare_silver','promo','double_rare','ultra_rare_silver','illustration_rare','illustration_sr','hyper_rare','chromatique_ur','high_tech'];

    // --- SVG helpers ---
    const svg=(p)=>`<svg viewBox="0 0 24 24" aria-hidden="true">${p}</svg>`;
    const star=(fill,stroke,strokeW=1.5)=>svg(`<path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.5L12 17.9 6.2 20.4l1.1-6.5L2.6 9.3l6.5-.9L12 2.5z" fill="${fill||'none'}" stroke="${stroke||'currentColor'}" stroke-width="${strokeW}"/>`);
    const circle=(fill,stroke)=>svg(`<circle cx="12" cy="12" r="7" fill="${fill||'none'}" stroke="${stroke||'currentColor'}" stroke-width="1.5"/>`);
    const diamond=(fill,stroke)=>svg(`<path d="M12 3l7 9-7 9-7-9 7-9z" fill="${fill||'none'}" stroke="${stroke||'currentColor'}" stroke-width="1.5"/>`);
    const COLORS={black:'#0f172a',silver:'#c0c9d6',gold:'#e3b341',goldStroke:'#d09a00',raspberry:'#e11d48',white:'#ffffff'};
    function rarityIconsByKey(key){
      switch(key){
        case 'commune': return `<span class='rarity'>${circle(COLORS.black, COLORS.black)}</span>`;
        case 'peu_commune': return `<span class='rarity'>${diamond(COLORS.black, COLORS.black)}</span>`;
        case 'rare': return `<span class='rarity'>${star(COLORS.black, COLORS.black)}</span>`;
        case 'rare_silver': return `<span class='rarity'>${star(COLORS.silver, COLORS.silver)}</span>`;
        case 'double_rare': return `<span class='rarity'>${star(COLORS.black, COLORS.black)}${star(COLORS.black, COLORS.black)}</span>`;
        case 'ultra_rare_silver': return `<span class='rarity'>${star(COLORS.silver, COLORS.silver)}${star(COLORS.silver, COLORS.silver)}</span>`;
        case 'illustration_rare': return `<span class='rarity'>${star(COLORS.gold, COLORS.gold)}</span>`;
        case 'illustration_sr': return `<span class='rarity'>${star(COLORS.gold, COLORS.gold)}${star(COLORS.gold, COLORS.gold)}</span>`;
        case 'hyper_rare': return `<span class='rarity'>${star(COLORS.gold, COLORS.gold)}${star(COLORS.gold, COLORS.gold)}${star(COLORS.gold, COLORS.gold)}</span>`;
        case 'chromatique_ur': return `<span class='rarity'>${star(COLORS.white, COLORS.goldStroke, 2)}${star(COLORS.white, COLORS.goldStroke, 2)}</span>`;
        case 'high_tech': return `<span class='rarity'>${star(COLORS.raspberry, COLORS.raspberry)}</span>`;
        case 'promo': return `<span class='rarity'><span class='rarity-label'>PROMO</span></span>`;
        default: return '';
      }
    }

    function rarityFromRow(r){ const code=String(r['Rareté']??'').trim(); const key=RARITY_MAP[code]; return {key,label:key?RARITY_LABELS[key]:null,raw:code}; }

    // ——— Raretés (dropdown à cases) ———
    const selectedRarities = new Set(RARITY_ORDER); // par défaut: toutes
    const rarityBtn=document.getElementById('rarityBtn');
    const rarityDD=document.getElementById('rarityDD');
    function buildRarityDropdown(){
      const box = document.getElementById('rarityChips');
      if(!box) return;
      box.innerHTML='';
      RARITY_ORDER.forEach(key=>{
        const id = 'rk_'+key;
        const wrap = document.createElement('span'); wrap.className='chip';
        const input = document.createElement('input'); input.type='checkbox'; input.id=id; input.checked=true; input.dataset.key=key;
        const label = document.createElement('label'); label.setAttribute('for', id); label.innerHTML = rarityIconsByKey(key); label.title = RARITY_LABELS[key];
        wrap.appendChild(input); wrap.appendChild(label); box.appendChild(wrap);
        input.addEventListener('change', ()=>{ if(input.checked) selectedRarities.add(key); else selectedRarities.delete(key); updateRarityBtn(); render(); });
      });
      document.getElementById('checkAll').onclick=()=>{ selectedRarities.clear(); RARITY_ORDER.forEach(k=>{selectedRarities.add(k); const el=document.getElementById('rk_'+k); if(el) el.checked=true;}); updateRarityBtn(); render(); };
      document.getElementById('uncheckAll').onclick=()=>{ RARITY_ORDER.forEach(k=>{selectedRarities.delete(k); const el=document.getElementById('rk_'+k); if(el) el.checked=false;}); updateRarityBtn(); render(); };
      updateRarityBtn();
    }
    function updateRarityBtn(){
      if(!rarityBtn) return;
      if(selectedRarities.size===RARITY_ORDER.length) rarityBtn.textContent='Toutes les raretés';
      else if(selectedRarities.size===0) rarityBtn.textContent='Aucune sélection';
      else rarityBtn.textContent=`${selectedRarities.size} rareté(s) sélectionnée(s)`;
    }
    if(rarityBtn){
      rarityBtn.addEventListener('click', (e) => { e.stopPropagation(); rarityDD.hidden = !rarityDD.hidden; });
      rarityDD.addEventListener('click', (e) => { e.stopPropagation(); });
      document.addEventListener('click', (e) => { if (!rarityDD.hidden && !e.target.closest('.multi')) { rarityDD.hidden = true; } });
    }

    // State
    let CARDS=[], SEALED=[], GRADED=[];

    // ---- Chargement auto depuis le repo ----
    const AUTO_SOURCES={ cards:'cartes.csv', sealed:'scelle.csv', graded:'gradees.csv' };

    function loadCsvFromUrl(url, cb, onError){
      fetch(url,{cache:'no-store'})
        .then(r=>{ if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.text(); })
        .then(text=> Papa.parse(text,{header:true,skipEmptyLines:true,complete:res=>cb(res.data)}))
        .catch(err=>{ console.warn('CSV auto-load failed for', url, err); onError && onError(err); });
    }

    // Auto-load
    loadCsvFromUrl(AUTO_SOURCES.cards, rows=>{ CARDS=normalizeRows(rows); refreshSeries(); render(); });
    loadCsvFromUrl(AUTO_SOURCES.sealed, rows=>{ SEALED=normalizeRows(rows); refreshSeries(); refreshSealedFilters(); render(); });
    loadCsvFromUrl(AUTO_SOURCES.graded, rows=>{ GRADED=normalizeRows(rows); refreshCompanies(); render(); });

    function normalizeRows(rows){
      return rows.map(r=>Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k).trim(), typeof v==='string'? v.trim(): v])));
    }

    // Upload fallback (?upload)
    if(SHOW_UPLOADS){
      document.getElementById('csv-cards').addEventListener('change', e=>{
        const f=e.target.files?.[0]; if(!f) return; parseFile(f, rows=>{ CARDS=normalizeRows(rows); refreshSeries(); render(); });
      });
      document.getElementById('csv-sealed').addEventListener('change', e=>{
        const f=e.target.files?.[0]; if(!f) return; parseFile(f, rows=>{ SEALED=normalizeRows(rows); refreshSeries(); refreshSealedFilters(); render(); });
      });
      document.getElementById('csv-graded').addEventListener('change', e=>{
        const f=e.target.files?.[0]; if(!f) return; parseFile(f, rows=>{ GRADED=normalizeRows(rows); refreshCompanies(); render(); });
      });
      document.getElementById('load-demo').addEventListener('click', ()=>{
        CARDS=[
          {'Série':'151','Numéro':'1/165','Nom':'Bulbizarre','Rareté':'1','Nb Normal':'1','Nb Reverse':'1','Nb Spéciale':'0','Image URL':'https://images.pokemontcg.io/sv3/fr/1_hires.png'},
          {'Série':'Écarlate et Violet','Numéro':'14/198','Nom':'Rare','Rareté':'5','Nb Normal':'1'},
          {'Série':'Zénith Suprême','Numéro':'GG05','Nom':'Lokhlass','Rareté':'33','Nb Normal':'1'},
          {'Série':'Couronne Stellaire','Numéro':'151/142','Nom':'Zeraora (Hyper rare)','Rareté':'36','Nb Spéciale':'1','Image URL':'https://pokecardex.b-cdn.net/assets/images/sets/SCR/HD/151.jpg?class=hd'}
        ];
        SEALED=[{'Série':'151','Type':'ETB','Détail':'Exemple','Commentaires':'—','Image':'https://via.placeholder.com/400x250?text=ETB+151'}];
        GRADED=[{'Nom':'Pikachu','Edition':'SWSH','Société':'PSA','Note':'10','Détail':'Test','Image':'https://via.placeholder.com/400x250?text=PSA+10'}];
        refreshSeries(); refreshSealedFilters(); refreshCompanies(); render();
      });
    }

    function parseFile(file, cb){ Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>cb(res.data)}); }

    // Filtres cartes
    const q=document.getElementById('q');
    const serie=document.getElementById('serie');
    const view=document.getElementById('view');
    q.oninput=serie.onchange=view.onchange=()=>render();

    // Filtres scellé
    const qs=document.getElementById('qs');
    const serieS=document.getElementById('serieS');
    const typeS=document.getElementById('typeS');
    if(qs) qs.oninput=()=>render();
    if(serieS) serieS.onchange=()=>render();
    if(typeS) typeS.onchange=()=>render();

    // Filtres gradées
    const qg=document.getElementById('qg');
    const company=document.getElementById('company');
    const minG=document.getElementById('minG');
    const minG_label=document.getElementById('minG_label');
    if(qg) qg.oninput=()=>render();
    if(company) company.onchange=()=>render();
    if(minG) minG.oninput=()=>{minG_label.textContent=minG.value; render();}

    // Raretés UI
    buildRarityDropdown();

    // ——————————— Normalisation & menus séries ———————————
    function rebuildSerieCanon() {
      const map = new Map();
      CARDS.forEach(r=>{
        const raw = normalize(r['Série']);
        if(!raw) return;
        const sl = slugify(raw);
        if(!map.has(sl)) map.set(sl, raw);
      });
      SEALED.forEach(r=>{
        const raw = normalize(r['Série']);
        if(!raw) return;
        const sl = slugify(raw);
        if(!map.has(sl)) map.set(sl, raw);
      });
      SERIE_CANON = map;
    }

    function refreshSeries(){
      rebuildSerieCanon();
      const options = ['all', ...Array.from(SERIE_CANON.keys()).sort((a,b)=>{
        return SERIE_CANON.get(a).localeCompare(SERIE_CANON.get(b),'fr');
      })];

      serie.innerHTML = options.map(sl=>{
        return `<option value="${sl}">${sl==='all' ? 'Toutes' : SERIE_CANON.get(sl)}</option>`;
      }).join('');

      const sSet = new Set(SEALED.map(r=>slugify(r['Série']||'')));
      const sList = ['all', ...Array.from(sSet).filter(Boolean).sort((a,b)=>{
        return SERIE_CANON.get(a)?.localeCompare(SERIE_CANON.get(b),'fr');
      })];
      if(serieS){
        serieS.innerHTML = sList.map(sl=>{
          const label = sl==='all' ? 'Toutes' : (SERIE_CANON.get(sl) || '');
          return `<option value="${sl}">${label}</option>`;
        }).join('');
      }
    }

    function refreshSealedFilters(){
      if(!(SEALED && SEALED.length)) return;
      const t=new Set();
      SEALED.forEach(r=>{ const raw = normalize(r['Type']); if(raw) t.add(raw); });
      const tOpt=['all',...Array.from(t).sort((a,b)=>a.localeCompare(b,'fr'))];
      if(typeS) typeS.innerHTML=tOpt.map(v=>`<option value="${v}">${v==='all'?'Tous':v}</option>`).join('');
    }

    function refreshCompanies(){
      const s=new Set(GRADED.map(r=>String(r['Société']||'')));
      const options=['all',...Array.from(s).filter(Boolean).sort((a,b)=>a.localeCompare(b,'fr'))];
      company.innerHTML=options.map(v=>`<option value="${v}">${v==='all'?'Toutes':v}</option>`).join('');
    }

    function ownedQty(r){
      const keys=["Nb Normal","Nb Ed1","Nb Reverse","Nb Spéciale","Quantité","Qty"]; return keys.map(k=>{ const n=Number(r[k]); return Number.isNaN(n)?0:Math.max(0,n); }).reduce((a,b)=>a+b,0);
    }
    function sortCardNumbers(a,b){
      const A=String(a['Numéro']||''); const B=String(b['Numéro']||'');
      const [mA,sA]=A.split('/').map(x=>parseInt(x,10)); const [mB,sB]=B.split('/').map(x=>parseInt(x,10));
      if(!Number.isNaN(mA)&&!Number.isNaN(mB)){ if(mA!==mB) return mA-mB; if(!Number.isNaN(sA)&&!Number.isNaN(sB)) return sA-sB; }
      return A.localeCompare(B,'fr',{numeric:true});
    }

    // Modal viewer
    const modal=document.getElementById('imgModal');
    const modalImg=document.getElementById('modalImg');
    const modalClose=document.getElementById('modalClose');
    function openModal(src,alt){
      modalImg.src=src; modalImg.alt=alt||''; modal.classList.add('open');
      document.body.style.overflow='hidden';
    }
    function closeModal(){
      modal.classList.remove('open'); modalImg.src='';
      document.body.style.overflow='';
    }
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    function hookImageClicks(container){
      container.addEventListener('click', (e)=>{
        const img = e.target.closest('.thumb img');
        if(img){ openModal(img.src, img.alt); }
      });
    }
    hookImageClicks(document.body);

    // ======= STATS =======
    function parseNumDen(numStr){
      const s = String(numStr||'').trim();
      const m = s.match(/^(\d+)\s*\/\s*(\d+)$/i); // ex 190/159
      if(!m) return null;
      return {num:parseInt(m[1],10), den:parseInt(m[2],10)};
    }
    function parseSubset(numStr){
      const s = String(numStr||'').trim();
      const m = s.match(/^([A-Za-z]+)\s*0*?(\d{1,3})$/i); // ex GG05
      if(!m) return null;
      return {prefix:m[1].toUpperCase(), n:parseInt(m[2],10)};
    }

    function computeStatsPerSeries(){
      const map = new Map();
      CARDS.forEach(r=>{
        const slug = slugify(r['Série']);
        if(!slug) return;

        const nbN = Number(r['Nb Normal'])||0;
        const nbR = Number(r['Nb Reverse'])||0;
        const nbS = Number(r['Nb Spéciale'])||0;

        if(!map.has(slug)){
          map.set(slug, {
            slug,
            label: SERIE_CANON.get(slug) || normalize(r['Série']),
            setSizeNum: 0,          // max du numérateur
            subsets: {},            // { GG: 70, TG: 30, ... }
            ownedN: 0, ownedR: 0, ownedS: 0,
            missing: []             // cartes manquantes (normales)
          });
        }
        const o = map.get(slug);

        const nd = parseNumDen(r['Numéro']);
        const sb = parseSubset(r['Numéro']);
        if(nd && Number.isFinite(nd.num)){
          if(nd.num > o.setSizeNum) o.setSizeNum = nd.num;
        }else if(sb && Number.isFinite(sb.n)){
          o.subsets[sb.prefix] = Math.max(o.subsets[sb.prefix]||0, sb.n);
        }

        if(nbN > 0) o.ownedN += 1; else o.missing.push({numero: String(r['Numéro']||'—'), nom: String(r['Nom']||'')});
        if(nbR > 0) o.ownedR += 1;
        if(nbS > 0) o.ownedS += 1;
      });

      const arr = Array.from(map.values()).map(o=>{
        const subsetsTotal = Object.values(o.subsets).reduce((a,b)=>a+b,0);
        const size = (o.setSizeNum||0) + subsetsTotal;
        const done = Math.min(o.ownedN, size);
        const pct = (size>0) ? (done/size)*100 : 0;
        return {...o, size, done, completion:pct};
      });
      arr.sort((a,b)=> b.completion - a.completion || a.label.localeCompare(b.label,'fr'));
      return arr;
    }

    function renderStats(){
      const root = document.getElementById('stats-root');
      const data = computeStatsPerSeries();
      if(!data.length){
        root.innerHTML = `<div class="empty">Pas de données cartes chargées.</div>`;
        root.onclick = null;
        return;
      }
      let html = '';
      data.forEach(s=>{
        const pct = Math.max(0, Math.min(100, s.completion));
        const subsetsTxt = Object.keys(s.subsets).length
          ? ' • Sous-ensembles : ' + Object.entries(s.subsets).map(([k,v])=>`${k}: ${v}`).join(', ')
          : '';
        html += `
          <div class="stat-row" data-slug="${s.slug}">
            <div class="stat-head">
              <div class="stat-title">${s.label}</div>
              <div class="progress" aria-hidden="true"><span style="width:${pct.toFixed(2)}%"></span></div>
              <div class="stat-meta">${s.done} / ${s.size} (${pct.toFixed(1)}%)</div>
            </div>
            <div class="stat-body">
              <div class="stat-break">
                <div><b>Normales possédées :</b> ${s.ownedN}</div>
                <div><b>Reverse possédées :</b> ${s.ownedR}</div>
                <div><b>Spéciales possédées :</b> ${s.ownedS}</div>
                ${subsetsTxt ? `<div style="color:#64748b">${subsetsTxt}</div>` : ''}
              </div>
              <div class="missing">
                <h4>Manquantes (normales) — ${s.missing.length}</h4>
                <div class="chips-list">
                  ${s.missing.map(m=>`<span>${m.numero} • ${m.nom}</span>`).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      });
      root.innerHTML = html;

      // Un seul handler, pas d'empilement
      root.onclick = (e)=>{
        const head = e.target.closest('.stat-head');
        if(!head) return;
        const row = head.closest('.stat-row');
        row.classList.toggle('open');
      };
    }

    // Rendu global
    function render(){
      // CARTES
      const root=document.getElementById('cards-root');
      if(!(CARDS&&CARDS.length)){ root.innerHTML=`<div class='empty'>Aucun CSV cartes chargé (auto : <code>${AUTO_SOURCES.cards}</code>)</div>`; }
      else{
        let rows=CARDS.slice();
        const selectedSlug = serie.value;
        if(selectedSlug !== 'all'){
          rows = rows.filter(r => slugify(r['Série']) === selectedSlug);
        }
        const q = document.getElementById('q');
        if(q.value.trim()){
          const qq=q.value.toLowerCase();
          rows=rows.filter(r=>['Nom','Numéro','Série'].some(k=>String(r[k]||'').toLowerCase().includes(qq)));
        }

        // Vue (possédées / manquantes / toutes)
        const mode = document.getElementById('view').value;
        if(mode==='owned'){
          rows = rows.filter(r => (Number(r['Nb Normal'])>0) || (Number(r['Nb Reverse'])>0) || (Number(r['Nb Spéciale'])>0) || (Number(r['Nb Ed1'])>0));
        }else if(mode==='missing'){
          rows = rows.filter(r => (Number(r['Nb Normal'])<=0));
        }

        // Raretés cochées
        rows=rows.filter(r=>{ const {key}=rarityFromRow(r); return !key || selectedRarities.has(key); });

        // Groupes par série
        const groupsMap = new Map();
        rows.forEach(r=>{
          const sl = slugify(r['Série']);
          if(!groupsMap.has(sl)) groupsMap.set(sl, []);
          groupsMap.get(sl).push(r);
        });
        const groups = Array.from(groupsMap.entries()).sort((a,b)=>{
          const la = SERIE_CANON.get(a[0]) || '';
          const lb = SERIE_CANON.get(b[0]) || '';
          return la.localeCompare(lb,'fr');
        });

        let html='';
        const rarityHtml=(r)=>{ const {key,label,raw}=rarityFromRow(r); return key? `${rarityIconsByKey(key)} <span class='rarity-label'>${label}</span>`: `<span class='rarity-label'>Rareté: ${raw||'—'}</span>`; };
        const badges=(r)=>{ const n=Number(r['Nb Normal'])>0, rv=Number(r['Nb Reverse'])>0, sp=Number(r['Nb Spéciale'])>0; return `<span class='badges'>${n?`<span class='ball red' title='Normale'></span>`:''}${rv?`<span class='ball yellow' title='Reverse'></span>`:''}${sp?`<span class='ball blue' title='Spéciale'></span>`:''}</span>`; };

        groups.forEach(([slug,arr])=>{
          const title = SERIE_CANON.get(slug) || 'Sans série';
          arr.sort(sortCardNumbers);
          html+=`<div class='section'><h3 style='margin:0 4px 10px 4px;font-size:16px;'>${title} <span class='hint'>(${arr.length} cartes)</span></h3><div class='grid'>`;
          arr.forEach(r=>{
            const url = r['Image URL'] || r['Image'] || '';
            const img = url? `<img loading='lazy' src='${url}' alt='${(r['Nom']||'')}'/>` : '';
            const qte=ownedQty(r);
            html+=`<div class='item'>
              <div class='thumb'>${img || '<span class="hint">(pas d\'image)</span>'}</div>
              <div class='meta'>
                <div class='t'>${(r['Numéro']||'')} • ${(r['Nom']||'Sans nom')}</div>
                <div class='s'>${rarityHtml(r)}<span>Qté: ${qte}</span>${badges(r)}</div>
                ${r['Prix']? `<div class='s'>Prix: ${r['Prix']}</div>`:''}
              </div>
            </div>`;
          });
          html+=`</div></div>`;
        });
        root.innerHTML=html||`<div class='empty'>Aucun résultat avec ces filtres.</div>`;
      }

      // SCELLÉ
      const rootS=document.getElementById('sealed-root');
      if(!(SEALED&&SEALED.length)){ rootS.innerHTML=`<div class='empty'>Aucun CSV scellé chargé (auto : <code>${AUTO_SOURCES.sealed}</code>)</div>`; }
      else{
        let rows=SEALED.slice();
        const selectedSlugS = document.getElementById('serieS') ? document.getElementById('serieS').value : 'all';
        const qs = document.getElementById('qs');
        const typeS = document.getElementById('typeS');
        if(selectedSlugS!=='all') rows=rows.filter(r=>slugify(r['Série'])===selectedSlugS);
        if(typeS && typeS.value!=='all') rows=rows.filter(r=>normalize(r['Type']||'')===typeS.value);
        if(qs && qs.value.trim()){
          const qq=qs.value.toLowerCase();
          rows=rows.filter(r=>['Type','Détail','Commentaires','Série'].some(k=>String(r[k]||'').toLowerCase().includes(qq)));
        }
        const groupsMap = new Map();
        rows.forEach(r=>{
          const sl = slugify(r['Série']);
          if(!groupsMap.has(sl)) groupsMap.set(sl, []);
          groupsMap.get(sl).push(r);
        });
        const groups = Array.from(groupsMap.entries()).sort((a,b)=>{
          const la = SERIE_CANON.get(a[0]) || '';
          const lb = SERIE_CANON.get(b[0]) || '';
          return la.localeCompare(lb,'fr');
        });

        let html='';
        groups.forEach(([slug,arr])=>{
          const title = SERIE_CANON.get(slug) || 'Sans série';
          html+=`<div class='section'><h3 style='margin:0 4px 10px 4px;font-size:16px;'>${title} <span class='hint'>(${arr.length})</span></h3><div class='grid' style='grid-template-columns:repeat(3,1fr)'>`;
          arr.forEach(r=>{
            const img = r['Image']? `<img loading='lazy' src='${r['Image']}' alt='${(r['Type']||'Item')}'/>` : '';
            html+=`<div class='item'>
              <div class='thumb img-short'>${img || '<span class="hint">(pas d\'image)</span>'}</div>
              <div class='meta'>
                <div class='t'>${(r['Type']||'Item')}</div>
                ${r['Détail']? `<div class='s'>Détail: ${r['Détail']}</div>`:''}
                ${r['Commentaires']? `<div class='s'>${r['Commentaires']}</div>`:''}
              </div>
            </div>`;
          });
          html+=`</div></div>`;
        });
        rootS.innerHTML=html;
      }

      // GRADÉES
      const rootG=document.getElementById('graded-root');
      if(!(GRADED&&GRADED.length)){ rootG.innerHTML=`<div class='empty'>Aucun CSV gradées chargé (auto : <code>${AUTO_SOURCES.graded}</code>)</div>`; }
      else{
        let rows=GRADED.slice();
        if(document.getElementById('company').value!=='all') rows=rows.filter(r=>String(r['Société'])===document.getElementById('company').value);
        if(document.getElementById('qg').value.trim()){ const qq=document.getElementById('qg').value.toLowerCase(); rows=rows.filter(r=>['Nom','Edition','Détail'].some(k=>String(r[k]||'').toLowerCase().includes(qq))); }
        const parseNote = v => { const s=String(v??'').replace(',', '.').trim(); const n=parseFloat(s); return Number.isFinite(n)? n : NaN; };
        const min=parseNote(document.getElementById('minG').value);
        rows=rows.filter(r=>{ const n=parseNote(r['Note']); return Number.isNaN(n)? true : n>=min; });
        rows.sort((a,b)=> String(a['Nom']||'').localeCompare(String(b['Nom']||''),'fr'));
        let html=`<div class='grid' style='grid-template-columns:repeat(3,1fr)'>`;
        rows.forEach(r=>{
          const img = r['Image']? `<img loading='lazy' src='${r['Image']}' alt='${(r['Nom']||'Carte')}'/>` : '';
          html+=`<div class='item'>
            <div class='thumb img-short'>${img || '<span class="hint">(pas d\'image)</span>'}</div>
            <div class='meta'>
              <div class='t'>${r['Nom']||'Carte'}</div>
              <div class='s'>Note: ${(r['Note']??'—')} (${r['Société']||'?'})</div>
              ${r['Edition']? `<div class='s'>Édition: ${r['Edition']}</div>`:''}
              ${r['Détail']? `<div class='s'>${r['Détail']}</div>`:''}
            </div>
          </div>`;
        });
        html+=`</div>`;
        rootG.innerHTML=html||`<div class='empty'>Aucun résultat.</div>`;
      }

      // STATS
      renderStats();
    }

    function parseFile(file, cb){ Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>cb(res.data)}); }
  }
</script>
</body>
</html>
